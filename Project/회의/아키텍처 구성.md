### 1. 전체 아키텍처 개요

```mermaid
flowchart LR
  %% GitHub
  gh_feat[feat-* 브랜치들] --> gh_dev[dev]
  gh_dev --> gh_master[master]

  %% CI/CD
  gh_dev --> ci_lint[CI: Lint/Test]
  gh_master --> ci_lint
  ci_lint --> ci_build[Build Image]
  ci_build --> ci_push[Push to Registry]
  ci_push --> ci_deploy[Deploy]

  %% Registry
  ci_build --> reg_img[Registry: app:TAG]
  reg_img --> ci_deploy

  %% Prod Server
  ci_deploy --> nginx[Nginx]
  nginx --> inc[service-url.inc]
  nginx --> up8080[Upstream 127.0.0.1:8080]
  nginx --> up8081[Upstream 127.0.0.1:8081]
  up8080 --- appblue[app-blue 8080]
  up8081 --- appgreen[app-green 8081]

```

GitHub 브랜치 → CI/CD → Registry → Prod Server(Nginx + Docker)로 이어지는 전체 배포 아키텍처 흐름.





### 2. 배포 과정

```mermaid
sequenceDiagram
  autonumber
  actor Dev as Developer
  participant Repo as GitHub (master/dev/feat-*)
  participant CI as GitHub Actions
  participant REG as Registry
  participant SRV as Prod Server
  participant N as Nginx
  participant D as Docker

  Dev->>Repo: push (feat-*/feat-ignore)
  Repo-->>CI: CI (lint/test)
  Dev->>Repo: PR -> dev
  Repo-->>CI: build image (dev tag)
  CI->>REG: push image

  Dev->>Repo: PR -> master (release)
  Repo-->>CI: deploy job
  CI->>SRV: SSH deploy
  SRV->>D: start new container on idle port
  SRV->>N: switch service-url.inc to idle
  SRV->>N: nginx reload
  Note over N: Zero-downtime cutover

  alt Rollback
    SRV->>N: switch back previous include
    SRV->>N: reload
    SRV->>D: stop faulty container
  end

```



개발자의 푸시부터 PR, 빌드, 레지스트리 푸시, 서버 배포, Nginx 전환, 롤백까지 이어지는 무중단 배포 시퀀스





### 3. 브랜치 전략



```mermaid
flowchart TD
  X1[feat-로그인] --> Y[dev]
  X2[feat-프로필] --> Y
  X3[feat-지도] --> Y

  Y --> Z[master]

  Y --> CI[CI 실행]
  Z --> CD[CI/CD 실행]

```



`feat-*` 브랜치는 `dev`로 머지되어 CI만 수행, `dev`는 `master`로 머지되어 최종 CI/CD가 실행



### 4. Blue/Green 상태 전환



```mermaid
stateDiagram-v2
  [*] --> Live_8080
  Live_8080 --> Live_8081: switch to 8081
  Live_8081 --> Live_8080: switch to 8080

```

무중단 배포법 : Blue/Green 방식으로 포트(8080/8081)를 교차 전환하며 서비스 중단 없이 새 버전 배포



### 5. CI / CD 타임라인

```mermaid
gantt
  dateFormat  HH:mm
  title CI/CD 파이프라인 (master 기준)
  section CI
  Lint/Test            :done,  des1, 00:00, 10m
  Build Image          :active, des2, 00:10, 8m
  Push to Registry     :        des3, 00:18, 4m
  section CD
  Start Idle Container :        des4, 00:22, 3m
  Health Check         :        des5, 00:25, 2m
  Swap & Reload        :        des6, 00:27, 1m
  Retire Old           :        des7, 00:28, 2m

```

master 배포 시 CI/CD 단계별 소요 시간(빌드 → 레지스트리 → 서버 배포 → 헬스체크 → 전환 → 롤백)을 Gantt 차트로 표현